{% extends "base.html" %}
{% load static %}
{% load group_filters %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/patient/patient_list.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
  {% if request.user|has_group:"Doctors" %}
    <div class="patient-list-wrapper">
      <div class="dashboard-header">
        <div class="header-content">
          <div class="title-section">
            <h1 class="page-title">
              <i class="fas fa-heartbeat heart-pulse"></i>
              Patient Management
            </h1>
            <p class="page-subtitle">Manage patient records and health insights</p>
          </div>
          
          <div class="control-panel">
            <form class="search-form" method="get" id="mainSearchForm">
              <div class="input-group">
                <input name="q" class="search-input" type="search" 
                       placeholder="Search patients by name, mobile, or email..." 
                       value="{{ search_query }}">
                <button class="btn search-btn" type="submit" title="Search">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </form>
            
            <div class="action-buttons">
              <a href="{% url 'patient:create_patient' %}" class="btn btn-primary new-patient-btn" title="Add New Patient">
                <i class="fas fa-user-plus"></i> New Patient
              </a>
              <button class="btn btn-secondary filter-btn" id="filterToggle">
                <i class="fas fa-filter"></i> Filters
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Panel -->
      <div class="filter-panel" id="filterPanel">
        <div class="filter-header">
          <h3><i class="fas fa-sliders-h me-2"></i>Filter Patients</h3>
          <button class="btn-close-filter" id="closeFilter">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form method="get" id="filterForm">
          <input type="hidden" name="q" value="{{ search_query }}">
          
          <div class="filter-body">
            <div class="filter-group">
              <label>Prediction Status:</label>
              <div class="filter-options">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="status" value="Positive" id="statusPositive"
                         {% if "Positive" in selected_statuses %}checked{% endif %}>
                  <label class="form-check-label" for="statusPositive">
                    <span class="badge prediction-bad">Positive</span>
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="status" value="Negative" id="statusNegative"
                         {% if "Negative" in selected_statuses %}checked{% endif %}>
                  <label class="form-check-label" for="statusNegative">
                    <span class="badge prediction-good">Negative</span>
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="status" value="Pending" id="statusPending"
                         {% if "Pending" in selected_statuses %}checked{% endif %}>
                  <label class="form-check-label" for="statusPending">
                    <span class="badge prediction-pending">Pending</span>
                  </label>
                </div>
              </div>
            </div>
            
            <div class="filter-group">
              <label>Gender:</label>
              <div class="filter-options">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="gender" value="M" id="genderMale"
                         {% if "M" in selected_genders %}checked{% endif %}>
                  <label class="form-check-label" for="genderMale">
                    <span class="badge gender-male">Male</span>
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="gender" value="F" id="genderFemale"
                         {% if "F" in selected_genders %}checked{% endif %}>
                  <label class="form-check-label" for="genderFemale">
                    <span class="badge gender-female">Female</span>
                  </label>
                </div>
              </div>
            </div>
            
            <div class="filter-actions">
              <button type="button" class="btn btn-secondary" id="resetFilters">Reset</button>
              <button type="submit" class="btn btn-primary">Apply Filters</button>
            </div>
          </div>
        </form>
      </div>

      <div class="summary-cards">
        <div class="summary-card total-patients">
          <div class="card-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="card-content">
            <h3>{{ patients.paginator.count }}</h3>
            <p>Total Patients</p>
          </div>
        </div>
        
        <div class="summary-card positive-cases">
          <div class="card-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="card-content">
            <h3>{{ positive_count }}</h3>
            <p>Positive Cases</p>
          </div>
        </div>
        
        <div class="summary-card new-this-week">
          <div class="card-icon">
            <i class="fas fa-user-plus"></i>
          </div>
          <div class="card-content">
            <h3>{{ new_this_week }}</h3>
            <p>New This Week</p>
          </div>
        </div>
      </div>

      <div class="patient-list-container">
        <div class="list-header">
          <h3><i class="fas fa-list me-2"></i>Patient Records</h3>
          <div class="list-actions">
            <div class="sort-options">
              <span>Sort by:</span>
              <select class="form-select" name="sort" id="sortSelect">
                <option value="recent" {% if selected_sort == "recent" %}selected{% endif %}>Recently Added</option>
                <option value="name_asc" {% if selected_sort == "name_asc" %}selected{% endif %}>Name (A-Z)</option>
                <option value="name_desc" {% if selected_sort == "name_desc" %}selected{% endif %}>Name (Z-A)</option>
                <option value="status" {% if selected_sort == "status" %}selected{% endif %}>Prediction Status</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="card shadow patient-list-card">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Patient</th>
                  <th>Contact</th>
                  <th>Gender</th>
                  <th>Last Visit</th>
                  <th>Prediction</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for patient in patients %}
                <tr>
                  <td>
                    <div class="patient-info">
                      <div class="patient-avatar">
                        {% if patient.gender == 'M' %}
                        <i class="fas fa-male"></i>
                        {% elif patient.gender == 'F' %}
                        <i class="fas fa-female"></i>
                        {% else %}
                        <i class="fas fa-user"></i>
                        {% endif %}
                      </div>
                      <div class="patient-details">
                        <strong>{{ patient.full_name }}</strong>
                        <small class="text-muted">ID: P-{{ patient.id|stringformat:"04d" }}</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="contact-info">
                      <div><i class="fas fa-phone me-2"></i>{{ patient.mobile }}</div>
                      <div><i class="fas fa-envelope me-2"></i>{{ patient.email }}</div>
                    </div>
                  </td>
                  <td>
                    {% if patient.gender == 'M' %}
                      <span class="badge gender-male"><i class="fas fa-mars"></i> Male</span>
                    {% elif patient.gender == 'F' %}
                      <span class="badge gender-female"><i class="fas fa-venus"></i> Female</span>
                    {% else %}
                      <span class="badge bg-secondary">Other</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="last-visit">{{ patient.last_visit|date:"d M Y" }}</span>
                  </td>
                  <td>
                    {% if patient.diabetes_prediction == "Positive" %}
                      <span class="badge prediction-bad"><i class="fas fa-exclamation-circle"></i> Positive</span>
                    {% elif patient.diabetes_prediction == "Negative" %}
                      <span class="badge prediction-good"><i class="fas fa-check-circle"></i> Negative</span>
                    {% else %}
                      <span class="badge prediction-pending"><i class="fas fa-clock"></i> Pending</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <div class="btn-group action-group">
                      <a href="{% url 'patient:detail' patient.pk %}"
                         class="btn btn-sm btn-info action-btn"
                         title="View Patient">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="{% url 'patient:edit' patient.pk %}"
                         class="btn btn-sm btn-warning action-btn"
                         title="Edit Patient">
                        <i class="fas fa-edit"></i>
                      </a>
                      <button class="btn btn-sm btn-light action-btn more-options" title="More Options">
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6" class="text-center py-5">
                    <div class="empty-state">
                      <i class="fas fa-user-injured fa-3x mb-3"></i>
                      <h4>No patients found</h4>
                      <p class="text-muted">Try adjusting your search or add a new patient</p>
                      <a href="{% url 'patient:create_patient' %}" class="btn btn-primary mt-2">
                        <i class="fas fa-user-plus me-1"></i> Add New Patient
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        
        {% if patients.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center">
            {% if patients.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{% include 'partials/query_string.html' with page=patients.previous_page_number %}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo;</span>
            </li>
            {% endif %}
            {% for num in patients.paginator.page_range %}
            <li class="page-item {% if patients.number == num %}active{% endif %}">
              <a class="page-link" href="?{% include 'partials/query_string.html' with page=num %}">{{ num }}</a>
            </li>
            {% endfor %}
            {% if patients.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{% include 'partials/query_string.html' with page=patients.next_page_number %}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <span class="page-link">&raquo;</span>
            </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div class="access-denied">
      <div class="container">
        <div class="error-card">
          <i class="fas fa-ban"></i>
          <h2>Access Denied</h2>
          <p>You don't have permission to view the patient list.</p>
          <p class="text-muted">Please contact your system administrator for assistance.</p>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Toggle filter panel
      const filterToggle = document.getElementById('filterToggle');
      const filterPanel = document.getElementById('filterPanel');
      const closeFilter = document.getElementById('closeFilter');
      
      if (filterToggle && filterPanel && closeFilter) {
        filterToggle.addEventListener('click', function() {
          filterPanel.classList.toggle('active');
        });
        
        closeFilter.addEventListener('click', function() {
          filterPanel.classList.remove('active');
        });
      }
      
      // Reset filters
      const resetBtn = document.getElementById('resetFilters');
      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          // Reset all checkboxes
          document.querySelectorAll('#filterForm input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
          });
          // Reset sort select
          document.getElementById('sortSelect').value = 'recent';
          // Submit the form to apply changes
          document.getElementById('filterForm').submit();
        });
      }
      
      // Handle sort change
      const sortSelect = document.getElementById('sortSelect');
      if (sortSelect) {
        sortSelect.addEventListener('change', function() {
          // Get current query parameters
          const params = new URLSearchParams(window.location.search);
          params.set('sort', this.value);
          window.location.search = params.toString();
        });
      }
    });
  </script>
{% endblock %}