{% extends "base.html" %}
{% load static widget_tweaks %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/appointments/secretary_settings.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
  .password-strength { font-size:.75rem; font-weight:600; min-height:1rem; }
  .password-strength[data-level="1"] { color:#d9534f; }
  .password-strength[data-level="2"] { color:#f0ad4e; }
  .password-strength[data-level="3"] { color:#ffc107; }
  .password-strength[data-level="4"] { color:#5cb85c; }
  .password-strength[data-level="5"] { color:#198754; }
  .invalid-feedback ul { margin:0; padding-left:1rem; list-style:disc; }
</style>
{% endblock %}

{% block content %}
<div class="settings-wrapper container py-5">

  <h1 class="mb-3 text-primary fw-bold d-flex align-items-center gap-2">
    <i class="bi bi-gear"></i> Account Settings
  </h1>

  <p class="text-muted mb-4">
    Update your profile information or change your password.
  </p>

  {% if messages %}
    <div class="mb-3" aria-live="polite">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row g-4">

    {# ---------------- Profile Form ---------------- #}
    <div class="col-lg-6">
      <div class="card shadow-sm h-100 settings-card">
        <div class="card-header bg-light fw-semibold d-flex align-items-center">
          <i class="bi bi-person-circle me-2"></i>
          <span>Profile Information</span>
        </div>
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            <input type="hidden" name="form_type" value="profile">

            {% if profile_form.non_field_errors %}
              <div class="alert alert-danger py-2 mb-3" role="alert" aria-live="assertive">
                {{ profile_form.non_field_errors }}
              </div>
            {% endif %}

            {% for field in profile_form %}
              <div class="mb-3">
                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                {% if field.errors %}
                  {% render_field field class+="form-control is-invalid" %}
                  <div class="invalid-feedback d-block">
                    <ul>
                      {% for err in field.errors %}
                        <li>{{ err }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% else %}
                  {% render_field field class+="form-control" %}
                {% endif %}
              </div>
            {% endfor %}

            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-save me-1"></i> Save Profile
            </button>
          </form>
        </div>
      </div>
    </div>

    {# ---------------- Password Form ---------------- #}
    <div class="col-lg-6">
      <div class="card shadow-sm h-100 settings-card">
        <div class="card-header bg-light fw-semibold d-flex align-items-center">
          <i class="bi bi-shield-lock me-2"></i>
          <span>Change Password</span>
        </div>
        <div class="card-body">
          <form method="post" id="passwordForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="form_type" value="password">

            {% if password_form.non_field_errors %}
              <div class="alert alert-danger py-2 mb-3" role="alert" aria-live="assertive">
                {{ password_form.non_field_errors }}
              </div>
            {% endif %}

            {# current_password #}
            <div class="mb-3">
              <label class="form-label" for="{{ password_form.current_password.id_for_label }}">
                {{ password_form.current_password.label }}
              </label>
              {% if password_form.current_password.errors %}
                {% render_field password_form.current_password class+="form-control is-invalid" autocomplete="current-password" %}
                <div class="invalid-feedback d-block">
                  {{ password_form.current_password.errors }}
                </div>
              {% else %}
                {% render_field password_form.current_password class+="form-control" autocomplete="current-password" %}
              {% endif %}
            </div>

            {# new_password #}
            <div class="mb-3">
              <label class="form-label" for="{{ password_form.new_password.id_for_label }}">
                {{ password_form.new_password.label }}
              </label>
              {% if password_form.new_password.errors %}
                {% render_field password_form.new_password class+="form-control is-invalid" autocomplete="new-password" aria-describedby="newPassHelp passwordStrength" %}
                <div class="invalid-feedback d-block">
                  {{ password_form.new_password.errors }}
                </div>
              {% else %}
                {% render_field password_form.new_password class+="form-control" autocomplete="new-password" aria-describedby="newPassHelp passwordStrength" %}
              {% endif %}

              {% if password_form.new_password.help_text %}
                <small id="newPassHelp" class="form-text text-muted d-block">
                  {{ password_form.new_password.help_text|safe }}
                </small>
              {% endif %}
              <div id="passwordStrength" class="password-strength" aria-live="polite"></div>
            </div>

            {# confirm_new_password #}
            <div class="mb-3">
              <label class="form-label" for="{{ password_form.confirm_new_password.id_for_label }}">
                {{ password_form.confirm_new_password.label }}
              </label>
              {% if password_form.confirm_new_password.errors %}
                {% render_field password_form.confirm_new_password class+="form-control is-invalid" autocomplete="new-password" %}
                <div class="invalid-feedback d-block">
                  {{ password_form.confirm_new_password.errors }}
                </div>
              {% else %}
                {% render_field password_form.confirm_new_password class+="form-control" autocomplete="new-password" %}
              {% endif %}
            </div>

            <button type="submit" class="btn btn-warning px-4">
              <i class="bi bi-key-fill me-1"></i> Change Password
            </button>
          </form>
        </div>
      </div>
    </div>

  </div><!-- /row -->
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/appointments/secretary_settings.js' %}"></script>
<script>
/* Password Strength Improved */
(function() {
  // استهداف الحقول بالاسم وليس بالـ id
  const input = document.querySelector('input[name="new_password"]');
  const box = document.getElementById('passwordStrength');
  if (!input || !box) return;

  function evaluate(v){
    if (!v) return {score:0,label:''};
    let s=0;
    if (v.length >= 8) s++;
    if (/[A-Z]/.test(v)) s++;
    if (/[a-z]/.test(v)) s++;
    if (/\d/.test(v)) s++;
    if (/[^A-Za-z0-9]/.test(v)) s++;
    const labels = ['Very Weak','Weak','Fair','Good','Strong','Excellent'];
    return {score:s,label:labels[s]};
  }

  input.addEventListener('input', ()=>{
    const {score,label} = evaluate(input.value);
    box.dataset.level = score;
    box.textContent = label ? 'Strength: '+label : '';
  });
})();
</script>
{% endblock %}
